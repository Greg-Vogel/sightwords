<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sight Word Quiz</title>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="container">
        <h1>Sight Word Quiz</h1>
        
        <div id="weekSelection">
            <h3>Week of:</h3>
            <select id="weekSelector">
                <option value="">-- Select a week --</option>
            </select>
        </div>

        <div id="modeSelection" style="display: none;">
            <div id="weekLabel"></div>
            <h3>Select a Practice Mode:</h3>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <button id="spellingModeBtn" class="mode-btn">Spelling</button>
                <button id="multipleChoiceModeBtn" class="mode-btn">Multiple Choice</button>
            </div>
        </div>

        <div id="quizArea" style="display: none;">
            <div id="weekLabel"></div>

            <div id="progressContainer">
                <div id="progressLabel"></div>
                <progress id="progressBar" value="0" max="100"></progress>
            </div>

            <!-- Multiple Choice Mode -->
            <div id="multipleChoiceCard" style="display: none;">
                <button id="wordDisplay" class="word-btn">ðŸ”Š</button>
                <div id="optionsGrid">
                    <button class="option-btn" data-index="0"></button>
                    <button class="option-btn" data-index="1"></button>
                    <button class="option-btn" data-index="2"></button>
                    <button class="option-btn" data-index="3"></button>
                </div>
            </div>

            <!-- Spelling Mode -->
            <div id="spellingCard" style="display: none;">
                <button id="spellingWordDisplay" class="word-btn">ðŸ”Š</button>
                <div id="spellingInputContainer">
                    <input type="text" id="spellingInput" placeholder="Type the word..." class="spelling-input" autocomplete="off" spellcheck="false">
                    <button id="spellingCheckBtn" class="spelling-check-btn">âœ“</button>
                </div>
                <div id="spellingFeedback"></div>
            </div>

            <button id="startOverBtn" class="start-over-btn">Start Over</button>
        </div>
    </div>

    <script>
        let wordsData = null;
        let currentWeek = null;
        let currentWordIndex = 0;
        let correctCount = 0;
        let weekWords = [];
        let currentUtterance = null;
        let currentMode = null; // 'spelling' or 'multipleChoice'

        // Play word sound using TTS
        function playWordSound(description) {
            // Cancel any ongoing speech
            speechSynthesis.cancel();
            
            // Split by break tags and create utterances with pauses
            const parts = description.split(/<break time="(\d+)ms"\/>/);
            let delay = 0;
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i].trim();
                
                // Skip empty parts and time values
                if (!part || /^\d+$/.test(part)) continue;
                
                // Schedule this part to be spoken after the accumulated delay
                setTimeout(() => {
                    currentUtterance = new SpeechSynthesisUtterance(part);
                    currentUtterance.rate = 0.8;
                    currentUtterance.pitch = 1;
                    speechSynthesis.speak(currentUtterance);
                }, delay);
                
                // Add 300ms pause after each part (300ms pause + estimated speech time)
                delay += 300;
            }
        }

        // Convert YYYYmmdd to Month dd format
        function formatWeekDate(yyyymmdd) {
            const year = parseInt(yyyymmdd.substring(0, 4));
            const month = parseInt(yyyymmdd.substring(4, 6)) - 1;
            const day = parseInt(yyyymmdd.substring(6, 8));
            const date = new Date(year, month, day);
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        }

        // Shuffle array
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Load words.json
        async function loadWords() {
            try {
                const response = await fetch('words.json');
                wordsData = await response.json();
                populateWeekSelector();
            } catch (error) {
                console.error('Error loading words.json:', error);
            }
        }

        // Populate week dropdown
        function populateWeekSelector() {
            const selector = document.getElementById('weekSelector');
            wordsData.forEach(weekData => {
                const option = document.createElement('option');
                option.value = weekData.week;
                option.textContent = 'Week of ' + formatWeekDate(weekData.week);
                selector.appendChild(option);
            });
        }

        // Handle week selection
        document.getElementById('weekSelector').addEventListener('change', (e) => {
            const selectedWeek = e.target.value;
            if (selectedWeek) {
                showModeSelection(selectedWeek);
            }
        });

        // Show mode selection screen
        function showModeSelection(weekValue) {
            currentWeek = weekValue;
            const weekData = wordsData.find(w => w.week === weekValue);
            weekWords = weekData.words;

            // Hide week selector and show mode selection
            document.getElementById('weekSelection').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';

            // Show selected week as label in mode selection
            document.querySelectorAll('#modeSelection #weekLabel')[0].textContent = 'Week of ' + formatWeekDate(weekValue);
        }

        // Handle mode selection buttons
        document.getElementById('spellingModeBtn').addEventListener('click', () => {
            startQuiz('spelling');
        });

        document.getElementById('multipleChoiceModeBtn').addEventListener('click', () => {
            startQuiz('multipleChoice');
        });

        // Start quiz with selected mode
        function startQuiz(mode) {
            currentMode = mode;
            currentWordIndex = 0;
            correctCount = 0;

            // Hide mode selection and show quiz
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';

            // Show selected week as label in quiz area
            document.querySelectorAll('#quizArea #weekLabel')[0].textContent = 'Week of ' + formatWeekDate(currentWeek);

            // Show the appropriate mode
            if (mode === 'spelling') {
                document.getElementById('multipleChoiceCard').style.display = 'none';
                document.getElementById('spellingCard').style.display = 'block';
                displaySpellingWord();
            } else {
                document.getElementById('spellingCard').style.display = 'none';
                document.getElementById('multipleChoiceCard').style.display = 'block';
                displayWord();
            }

            updateProgress();
        }

        // Display current word
        function displayWord() {
            const currentWord = weekWords[currentWordIndex];
            const wordBtn = document.getElementById('wordDisplay');
            wordBtn.innerHTML = 'ðŸ”Š';
            wordBtn.onclick = () => playWordSound(currentWord.description);
            
            // Play word sound automatically after a short delay
            setTimeout(() => {
                playWordSound(currentWord.description);
            }, 500);

            // Create options: word + 3 alternates
            const options = [
                currentWord.word,
                currentWord.alternate1,
                currentWord.alternate2,
                currentWord.alternate3
            ];

            // Shuffle options
            const shuffledOptions = shuffle(options);

            // Set correct answer index for validation
            const correctIndex = shuffledOptions.indexOf(currentWord.word);
            window.correctAnswerIndex = correctIndex;

            // Update buttons
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, index) => {
                btn.textContent = shuffledOptions[index];
                btn.onclick = () => checkAnswer(index, correctIndex);
                btn.classList.remove('correct', 'incorrect');
                btn.disabled = false;
            });
        }

        // Check answer
        function checkAnswer(selectedIndex, correctIndex) {
            const buttons = document.querySelectorAll('.option-btn');
            
            if (selectedIndex === correctIndex) {
                correctCount++;
                buttons[selectedIndex].classList.add('correct');
                updateProgress();
                
                // Move to next word after delay
                setTimeout(() => {
                    if (currentWordIndex < weekWords.length - 1) {
                        currentWordIndex++;
                        displayWord();
                    } else {
                        showCompletion();
                    }
                }, 1000);
            } else {
                buttons[selectedIndex].classList.add('incorrect');
                buttons[correctIndex].classList.add('correct');
                buttons.forEach(btn => btn.disabled = true);
                
                // Move to next word after delay
                setTimeout(() => {
                    if (currentWordIndex < weekWords.length - 1) {
                        currentWordIndex++;
                        displayWord();
                    } else {
                        showCompletion();
                    }
                }, 1500);
            }
        }

        // Display current word for spelling mode
        function displaySpellingWord() {
            const currentWord = weekWords[currentWordIndex];
            const spellingWordBtn = document.getElementById('spellingWordDisplay');
            const spellingInput = document.getElementById('spellingInput');
            const spellingCheckBtn = document.getElementById('spellingCheckBtn');

            spellingWordBtn.innerHTML = 'ðŸ”Š';
            spellingWordBtn.onclick = () => playWordSound(currentWord.description);

            // Play word sound automatically after a short delay
            setTimeout(() => {
                playWordSound(currentWord.description);
            }, 500);

            // Clear input and feedback, re-enable input
            spellingInput.value = '';
            spellingInput.disabled = false;
            spellingCheckBtn.disabled = false;
            spellingInput.focus();
            document.getElementById('spellingFeedback').innerHTML = '';
            document.getElementById('spellingFeedback').className = '';
        }

        // Handle spelling submission
        function handleSpellingSubmit() {
            const currentWord = weekWords[currentWordIndex];
            const userInput = document.getElementById('spellingInput').value.trim();
            const feedbackDiv = document.getElementById('spellingFeedback');
            const spellingInput = document.getElementById('spellingInput');

            // Case-insensitive comparison
            const isCorrect = userInput.toLowerCase() === currentWord.word.toLowerCase();

            if (isCorrect) {
                correctCount++;
                feedbackDiv.innerHTML = 'âœ“ Correct!';
                feedbackDiv.className = 'spelling-feedback correct';
                spellingInput.disabled = true;
                document.getElementById('spellingCheckBtn').disabled = true;
                updateProgress();

                // Move to next word after delay
                setTimeout(() => {
                    if (currentWordIndex < weekWords.length - 1) {
                        currentWordIndex++;
                        displaySpellingWord();
                    } else {
                        showCompletion();
                    }
                }, 1000);
            } else {
                feedbackDiv.innerHTML = `âœ— Incorrect. The word was: <strong>${currentWord.word}</strong>`;
                feedbackDiv.className = 'spelling-feedback incorrect';
                spellingInput.disabled = true;
                document.getElementById('spellingCheckBtn').disabled = true;

                // Move to next word after delay
                setTimeout(() => {
                    if (currentWordIndex < weekWords.length - 1) {
                        currentWordIndex++;
                        displaySpellingWord();
                    } else {
                        showCompletion();
                    }
                }, 3000);
            }
        }

        // Update progress bar
        function updateProgress() {
            const total = weekWords.length;
            const percentage = (correctCount / total) * 100;
            document.getElementById('progressBar').value = percentage;
            document.getElementById('progressLabel').textContent = `${correctCount} / ${total} correct`;
        }

        // Start Over - return to week selection
        function startOver() {
            speechSynthesis.cancel();
            document.getElementById('quizArea').style.display = 'none';
            // Show week selection so the user can choose a different week
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('weekSelection').style.display = 'block';
            document.getElementById('weekSelector').value = '';
            currentWeek = null;
            currentWordIndex = 0;
            correctCount = 0;
            currentMode = null;
        }

        // Handle start over button
        document.getElementById('startOverBtn').addEventListener('click', startOver);

        // Handle spelling input - Submit on Enter or Check button click
        document.getElementById('spellingInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.target.disabled) {
                handleSpellingSubmit();
            }
        });

        document.getElementById('spellingCheckBtn').addEventListener('click', () => {
            if (!document.getElementById('spellingInput').disabled) {
                handleSpellingSubmit();
            }
        });

        // Show completion message
        function showCompletion() {
            const total = weekWords.length;
            const percentage = Math.round((correctCount / total) * 100);
            document.getElementById('wordCard').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>Week Complete!</h2>
                    <p>You got ${correctCount} out of ${total} correct (${percentage}%)</p>
                </div>
            `;
        }

        // Load words on page load
        loadWords();
    </script>
</body>
</html>